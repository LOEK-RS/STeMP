---
title: "STeMP: Spatio-TEmporal Modelling Protocol"
output:
  pdf_document:
    toc: false
    number_sections: false
    latex_engine: xelatex
    extra_dependencies: ["longtable", "booktabs"]
header-includes:
  - \usepackage[table]{xcolor}
  - \usepackage{makecell}  # for better multi-line cells
  - \usepackage{longtable}
  - \usepackage{booktabs}
params:
  data: NULL
  plot_files: NULL
---

<!--
  This R Markdown template generates the STeMP protocol PDF report.
  
  It renders:
  - A formatted table of protocol data (params$data) with line wrapping and multi-line LaTeX cells.
  - Figures included from the provided plot file paths (params$plot_files).
  
  The document is compiled using XeLaTeX with specific LaTeX packages for styling.
  
  Usage:
  - Pass a data.frame to `params$data` with columns expected by the table renderer.
  - Provide vector of plot file paths to `params$plot_files` to include figures.
-->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Table
```{r echo=FALSE, message=FALSE}
df <- params$data

# Create empty data frame if no rows are given
if (is.null(df) || nrow(df) == 0) {
	df <- data.frame(
		section = character(0),
		subsection = character(0),
		element = character(0),
		value = character(0),
		stringsAsFactors = FALSE
	)
}

# Wrap and escape only if there are rows
if (nrow(df) > 0) {
	# Ensure 'value' column exists
	if (!"value" %in% names(df)) {
		df$value <- character(nrow(df))
	}

	# Convert to character before wrapping
	df$value <- stringr::str_wrap(as.character(df$value), width = 30)

	# Replace newline with LaTeX line break wrapped in \makecell{}
	df$value <- paste0("\\makecell[l]{", gsub("\n", " \\\\ ", df$value), "}")
}

# Remove 'visible' column if exists
if ("visible" %in% names(df)) {
	df$visible <- NULL
}

row.names(df) <- NULL

names(df) <- sapply(names(df), STeMP::sanitize_latex)

knitr::kable(df, format = "latex", booktabs = TRUE, longtable = TRUE, escape = FALSE) |>
	kableExtra::kable_styling(latex_options = c("striped", "hold_position"), font_size = 6) |>
	kableExtra::column_spec(1, width = "2cm") |>
	kableExtra::column_spec(2, width = "4cm") |>
	kableExtra::column_spec(3, width = "4cm") |>
	kableExtra::column_spec(4, width = "6cm")


```

# Figures
```{r echo=FALSE, out.width="80%", fig.align='center'}
if (!is.null(params$plot_files) && length(params$plot_files) > 0) {
	knitr::include_graphics(as.character(params$plot_files))
}
```


